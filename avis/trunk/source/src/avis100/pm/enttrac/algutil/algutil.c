//algutil.c
/*---------------------------------------------------------------------------*/
/* Determine length of i386 instruction                                      */
/*---------------------------------------------------------------------------*/

#include "./algutil.h"

/** This is used to figure out where the next instruction is.
    The high nibble means:
    0 - Length of instruction in low nibble.
    1 - Second byte of op is mod/reg/rm.  After whatever data
        that calls for, <low nibble> more bytes follow.  If
        <low nibble> is F, special case (for F6/F7 TEST insts).
    2 - Two-byte short (conditional) jump; offset in second byte
    3 - Intrasegment jump or call; offset in following word
    4 - Some other sort of jmp or call or ret or...  Low
        nibble is instruction length.
    F - Something special
**/
unsigned char alg_length_table[256] = {
/* 0x */ 0x10,0x10,0x10,0x10, 0x02,0x03,0x01,0x01, 0x10,0x10,0x10,0x10, 0x02,0x03,0x01,0x02,
/* 1x */ 0x10,0x10,0x10,0x10, 0x02,0x03,0x01,0x01, 0x10,0x10,0x10,0x10, 0x02,0x03,0x01,0x01,
/* 2x */ 0x10,0x10,0x10,0x10, 0x02,0x03,0x01,0x01, 0x10,0x10,0x10,0x10, 0x02,0x03,0x01,0x01,
/* 3x */ 0x10,0x10,0x10,0x10, 0x02,0x03,0x01,0x01, 0x10,0x10,0x10,0x10, 0x02,0x03,0x01,0x01,
/* 4x */ 0x01,0x01,0x01,0x01, 0x01,0x01,0x01,0x01, 0x01,0x01,0x01,0x01, 0x01,0x01,0x01,0x01,
/* 5x */ 0x01,0x01,0x01,0x01, 0x01,0x01,0x01,0x01, 0x01,0x01,0x01,0x01, 0x01,0x01,0x01,0x01,
/* 6x */ 0x01,0x01,0x10,0x01, 0x01,0x01,0x01,0x01, 0x03,0x12,0x02,0x11, 0x01,0x01,0x01,0x01,
/* 7x */ 0x20,0x20,0x20,0x20, 0x20,0x20,0x20,0x20, 0x20,0x20,0x20,0x20, 0x20,0x20,0x20,0x20,
/* 8x */ 0x11,0x12,0x11,0x11, 0x10,0x10,0x10,0x10, 0x10,0x10,0x10,0x10, 0x10,0x10,0x10,0x10,
/* 9x */ 0x01,0x01,0x01,0x01, 0x01,0x01,0x01,0x01, 0x01,0x01,0x45,0x01, 0x01,0x01,0x01,0x01,
/* Ax */ 0x03,0x03,0x03,0x03, 0x01,0x01,0x01,0x01, 0x02,0x03,0x01,0x01, 0x01,0x01,0x01,0x01,
/* Bx */ 0x02,0x02,0x02,0x02, 0x02,0x02,0x02,0x02, 0x03,0x03,0x03,0x03, 0x03,0x03,0x03,0x03,
/* Cx */ 0x11,0x11,0x43,0x41, 0x10,0x10,0x11,0x12, 0x04,0x01,0x43,0x41, 0x01,0x02,0x01,0x01,
/* Dx */ 0x10,0x10,0x10,0x10, 0x01,0x01,0x01,0x01, 0x10,0x10,0x10,0x10, 0x10,0x10,0x10,0x10,
/* Ex */ 0x02,0x02,0x02,0x02, 0x02,0x02,0x02,0x02, 0x30,0x30,0x45,0x20, 0x01,0x01,0x01,0x01,
/* Fx */ 0x01,0x01,0x01,0x01, 0x01,0x01,0x1F,0x1F, 0x01,0x01,0x01,0x01, 0x01,0x01,0x10,0x10
};

/* Return the length of the instruction at buf[ip], or -1 if error */
int alg_inslen(unsigned char *buf, int ip)
{
  int v;

  switch (alg_length_table[buf[ip]]>>4) {
  case 0x00:  /* Simple fixed-length instruction */
    return alg_length_table[buf[ip]];
    break;
  case 0x01:  /* Simple mod/reg/rm case */
    if ((alg_length_table[buf[ip]] & 0x0F)!=0x0F) {
      return alg_rmlen(buf+ip) + ( alg_length_table[buf[ip]] & 0x0F );
    } else {  /* Harder case; add one or two iff "reg" field is zero */
      v = alg_rmlen(buf+ip);
      if ((buf[ip+1]&0x38)==0) v += (buf[ip]&0x01) ? 2 : 1;
      return v;
    }
    break;
  case 0x02:  /* Two-byte short jump */
    return 2;
    break;
  case 0x03: /* Intrasegment jmp or call */
    return 3;
    break;
  case 0x04:  /* Fixed-length jmp/call/ret etc */
    return ( alg_length_table[buf[ip]] & 0x0F );
    break;
  default:
    return -1;
  } /* endswitch */
  return -1;
}

/** Return the length of the r/m-format instruction in the buffer. **/
int alg_rmlen(unsigned char *ptr)
{
  unsigned char b;

  b = *(ptr+1);

  switch ((b>>6)&0x03) {    /* Look at MOD field */
  case 0x00:              /* DISP=0, or EA is disp-hi;disp-lo */
    if ((b&0x07)==0x06)  /* Check for special case */
      {
	return 4;    /* op mod-reg-r/m disp-hi disp-lo */
      }
    return 2;       /* op mod-reg-r/m */
    break;
  case 0x01:
    return 3;      /* op mod-reg-r/m disp-lo (signed) */
    break;
  case 0x02:
    return 4;      /* op mod-reg-r/m disp-lo disp-hi */
    break;
  case 0x03:
    return 2;      /* op mod-reg-reg */
    break;
  } /* endswitch */
  
  return 0;         /* Not possible */
}  /* end alg_rmlen */










